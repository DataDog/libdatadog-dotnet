# SPDX-License-Identifier: Apache-2.0
#
# Unless explicitly stated otherwise all files in this repository are licensed
# under the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2025-present Datadog, Inc.

name: Build Platform

on:
  workflow_call:
    inputs:
      libdatadog_version:
        description: 'Libdatadog version to build (e.g., v25.0.0, or main for latest)'
        required: true
        type: string
      feature_preset:
        description: 'Feature preset: minimal, standard, or full'
        required: false
        type: string
        default: 'minimal'
      verify_artifacts:
        description: 'Whether to verify build artifacts after building'
        required: false
        type: boolean
        default: false
    outputs:
      libdatadog_version:
        description: 'The libdatadog version that was built'
        value: ${{ jobs.build.outputs.libdatadog_version }}

permissions:
  contents: read

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows builds
          - arch: x64
            platform: x64-windows
            target: x86_64-pc-windows-msvc
            os: windows-latest
          - arch: x86
            platform: x86-windows
            target: i686-pc-windows-msvc
            os: windows-latest
          # Linux x64 builds
          - arch: x64
            platform: x86_64-unknown-linux-gnu
            target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - arch: x64
            platform: x86_64-alpine-linux-musl
            target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          # Linux ARM64 builds
          - arch: arm64
            platform: aarch64-unknown-linux-gnu
            target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - arch: arm64
            platform: aarch64-alpine-linux-musl
            target: aarch64-unknown-linux-musl
            os: ubuntu-latest
          # macOS builds
          - arch: x64
            platform: x86_64-apple-darwin
            target: x86_64-apple-darwin
            os: macos-15-large
          - arch: arm64
            platform: aarch64-apple-darwin
            target: aarch64-apple-darwin
            os: macos-15
    outputs:
      libdatadog_version: ${{ inputs.libdatadog_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Rust
        run: |
          rustup update stable
          rustup default stable
          rustup component add rustfmt clippy
          rustup target add ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Install cross for all Linux targets to ensure GLIBC 2.17 compatibility
          cargo install cross --git https://github.com/cross-rs/cross
          sudo apt-get update
          case "${{ matrix.target }}" in
            aarch64-*-linux-*)
              sudo apt-get install -y binutils-aarch64-linux-gnu
              ;;
            x86_64-*-musl)
              sudo apt-get install -y musl-tools
              ;;
          esac

      - name: Add macOS target (macOS only)
        if: runner.os == 'macOS' && matrix.target != matrix.arch
        run: rustup target add ${{ matrix.target }}

      - name: Install LLVM tools (macOS only)
        if: runner.os == 'macOS'
        run: |
          brew install llvm
          echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

      - name: Build ${{ matrix.platform }}
        env:
          CARGO_BUILD_TARGET: ${{ matrix.target }}
          FEATURE_PRESET: ${{ inputs.feature_preset }}
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            pwsh -Command "./build.ps1 -LibdatadogVersion '${{ inputs.libdatadog_version }}' -Platform '${{ matrix.platform }}' -Features '${FEATURE_PRESET}' -Clean"
          else
            chmod +x build.sh
            ./build.sh --version "${{ inputs.libdatadog_version }}" --platform "${{ matrix.platform }}" --features "${FEATURE_PRESET}" --clean
          fi
        shell: bash

      - name: Verify build artifacts
        if: inputs.verify_artifacts
        run: |
          output_dir="output/libdatadog-${{ matrix.platform }}"

          if [ "$RUNNER_OS" == "Windows" ]; then
            # Check for Windows DLL (in release/dynamic for Windows builds)
            if [ ! -f "$output_dir/release/dynamic/datadog_profiling_ffi.dll" ]; then
              echo "Error: Release DLL not found at $output_dir/release/dynamic/datadog_profiling_ffi.dll"
              exit 1
            fi
          else
            # Check for shared library (in lib for Linux/macOS builds)
            if [ ! -f "$output_dir/lib/libdatadog_profiling.so" ] && [ ! -f "$output_dir/lib/libdatadog_profiling.dylib" ]; then
              echo "Error: Shared library not found"
              exit 1
            fi
          fi

          # Check for headers
          if [ ! -d "$output_dir/include/datadog" ] || [ -z "$(ls -A $output_dir/include/datadog)" ]; then
            echo "Error: Headers not found or empty"
            exit 1
          fi

          # Check for license files
          if [ ! -f "$output_dir/LICENSE" ]; then
            echo "Error: LICENSE not found"
            exit 1
          fi

          echo "Build artifacts verified successfully!"
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: libdatadog-${{ matrix.platform }}
          path: output/libdatadog-${{ matrix.platform }}
          if-no-files-found: error
          retention-days: 7
